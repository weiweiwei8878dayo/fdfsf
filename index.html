<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; color: #333; padding: 20px; text-align: center; }
        h1 { color: #444; margin-bottom: 20px; }
        
        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆç”¨ã‚¯ãƒ©ã‚¹ */
        .hidden { display: none !important; }
        
        .error { color: red; font-weight: bold; }
        a { text-decoration: none; cursor: pointer; color: #007bff; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; margin: 5px; }
        button { padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { opacity: 0.9; }

        .container { background: white; padding: 40px; border-radius: 10px; max-width: 600px; margin: 30px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .queue-alert { background: #e9ecef; color: #555; padding: 10px; border-radius: 5px; margin-bottom: 20px; display: inline-block; }
        .queue-count { color: #d9534f; font-weight: bold; font-size: 1.2em; }

        .result-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #28a745; margin-top: 20px; text-align: left; }
        .label { font-weight: bold; color: #555; }
        .value { font-weight: bold; margin-left: 10px; }
        
        #admin-view { max-width: 1200px; margin: 0 auto; }
        .dashboard { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-value { font-size: 1.5em; font-weight: bold; margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background: #007bff; color: white; }
        
        .badge-wait { color: #d9534f; }
        .badge-work { color: #f0ad4e; }
        .badge-done { color: #5cb85c; }
        .badge-cancel { color: #999; text-decoration: line-through; }

        .chat-box { font-size: 0.85em; text-align: left; max-height: 120px; overflow-y: auto; background: #f8f9fa; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px; }
        .chat-msg { margin-bottom: 6px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .sender-admin { color: #007bff; font-weight: bold; }
        .sender-user { color: #28a745; font-weight: bold; }
        .chat-time { font-size: 0.7em; color: #999; margin-left: 5px; float: right; }
    </style>
</head>
<body>

    <!-- â–¼ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ (åˆæœŸè¡¨ç¤º) â–¼ -->
    <div id="login-view" class="container">
        <h1>ğŸ”’ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
        <input type="password" id="adminPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <br>
        <button type="button" onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p style="margin-top:15px;"><a onclick="showUserView()">ä¸€èˆ¬ã®ãŠå®¢æ§˜ã¯ã“ã¡ã‚‰</a></p>
    </div>

    <!-- â–¼ ãŠå®¢æ§˜ç”¨ç”»é¢ (hiddenã‚¯ãƒ©ã‚¹ã§éš ã—ã¦ãŠã) â–¼ -->
    <div id="user-view" class="container hidden">
        <h1>ğŸ“¦ ã”ä¾é ¼çŠ¶æ³ã®ç¢ºèª</h1>
        <div class="queue-alert">ç¾åœ¨ã€<span id="queue-count" class="queue-count">-</span> ä»¶ã®ä¾é ¼ãŒé€²è¡Œä¸­ã§ã™ğŸ”¥</div>
        <div>
            <input type="text" id="searchId" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID">
            <br>
            <input type="text" id="searchOrderId" placeholder="æ³¨æ–‡ID">
            <br>
            <button type="button" onclick="fetchUserData()">æ¤œç´¢</button>
        </div>
        <div id="result-area" class="hidden"></div>
        <p id="msg" class="hidden error"></p>
        <p style="margin-top:15px;"><a onclick="showLoginView()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a></p>
    </div>

    <!-- â–¼ ç®¡ç†è€…ç”¨ç”»é¢ â–¼ -->
    <div id="admin-view" class="hidden">
        <h1>ğŸ”§ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <div class="dashboard">
            <div class="stat-card"><div>ğŸ’° ä»Šæœˆã®å£²ä¸Š</div><div class="stat-value" id="stat-month" style="color:#28a745">0å††</div></div>
            <div class="stat-card"><div>ğŸ’´ å…¨æœŸé–“ã®å£²ä¸Š</div><div class="stat-value" id="stat-total" style="color:#28a745">0å††</div></div>
            <div class="stat-card"><div>âš ï¸ æ”¯æ‰•ã„å¾…ã¡</div><div class="stat-value" id="stat-wait" style="color:#d9534f">0</div></div>
            <div class="stat-card"><div>ğŸ› ï¸ ä½œæ¥­ä¸­</div><div class="stat-value" id="stat-work" style="color:#f0ad4e">0</div></div>
        </div>
        <div style="margin-bottom:15px;">
            <button type="button" onclick="filterTable('all')">å…¨ã¦</button>
            <button type="button" onclick="filterTable('wait')">æ”¯æ‰•ã„å¾…ã¡</button>
            <button type="button" onclick="filterTable('work')">ä½œæ¥­ä¸­</button>
            <button type="button" onclick="filterTable('done')">å®Œäº†</button>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>æ—¥æ™‚</th><th>åå‰</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å†…å®¹</th><th>âœ‰ï¸ ãƒãƒ£ãƒƒãƒˆå±¥æ­´</th><th>é‡‘é¡</th><th>è¨¼æ‹ </th><th>ID</th></tr>
                </thead>
                <tbody id="admin-tbody"></tbody>
            </table>
        </div>
        <p style="margin-top:20px;"><a onclick="showLoginView()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a></p>
    </div>

    <script>
        let globalData = [];

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const orderId = params.get('orderId');

            // å¾…ã¡äººæ•°ã¯è£ã§å–å¾—
            fetch('/.netlify/functions/get-data?id=queue_count')
                .then(r => r.json()).then(d => { document.getElementById('queue-count').textContent = d.count || 0; }).catch(() => {});

            // URLã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€å¼·åˆ¶çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã¸
            if (id && orderId) {
                console.log("Customer link detected. Switching view...");
                document.getElementById('searchId').value = id;
                document.getElementById('searchOrderId').value = orderId;
                
                // â˜…ã“ã“ã§å¼·åˆ¶åˆ‡ã‚Šæ›¿ãˆ
                showUserView();
                
                // è‡ªå‹•æ¤œç´¢å®Ÿè¡Œ
                fetchUserData();
            } else {
                // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
                showLoginView();
            }
        };

        // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•° ---
        function showLoginView() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.add('hidden');
        }
        function showUserView() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
        }
        function showAdminView() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
        }

        // --- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ ---
        async function adminLogin() {
            const password = document.getElementById('adminPass').value;
            try {
                const res = await fetch('/.netlify/functions/get-data', {
                    method: 'POST',
                    body: JSON.stringify({ password })
                });
                if (res.ok) {
                    const data = await res.json();
                    globalData = data;
                    showAdminView();
                    updateDashboard(data);
                    renderAdminTable(data);
                } else { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); }
            } catch (e) { alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼'); }
        }

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ ---
        async function fetchUserData() {
            const userId = document.getElementById('searchId').value.trim();
            const orderId = document.getElementById('searchOrderId').value.trim();
            const msg = document.getElementById('msg');
            const resultArea = document.getElementById('result-area');

            if (!userId || !orderId) {
                msg.textContent = "IDã¨æ³¨æ–‡IDã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
                msg.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`/.netlify/functions/get-data?id=${userId}&orderId=${orderId}`);
                const data = await res.json();
                
                if (data.length > 0) {
                    msg.classList.add('hidden');
                    resultArea.classList.remove('hidden');
                    renderUserCard(data[0]);
                } else {
                    msg.textContent = "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (URLãŒå¤ã„ã‹ã€IDãŒé–“é•ã£ã¦ã„ã¾ã™)";
                    msg.classList.remove('hidden');
                    resultArea.classList.add('hidden');
                }
            } catch (e) { msg.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; msg.classList.remove('hidden'); }
        }

        // --- è¡¨ç¤ºç³» ---
        function renderUserCard(d) {
            const area = document.getElementById('result-area');
            area.innerHTML = ''; 
            const card = document.createElement('div');
            card.className = 'result-card';

            const fields = [
                { l: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', v: d.status },
                { l: 'æ›´æ–°æ—¥æ™‚', v: new Date(d.lastUpdate).toLocaleString('ja-JP') },
                { l: 'å†…å®¹', v: d.item },
                { l: 'é‡‘é¡', v: d.amount ? d.amount + "å††" : "-" },
                { l: 'BANä¿è¨¼', v: d.banOption === "yes" ? "ã‚ã‚Š" : "ãªã—" }
            ];

            fields.forEach(f => {
                const p = document.createElement('p');
                const label = document.createElement('span');
                label.className = 'label';
                label.textContent = f.l + ": ";
                const val = document.createElement('span');
                val.className = 'value';
                val.textContent = f.v;
                if (f.l === 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹') {
                    if (d.status.includes('å¾…ã¡')) val.classList.add('badge-wait');
                    else if (d.status.includes('ä½œæ¥­')) val.classList.add('badge-work');
                    else if (d.status.includes('å®Œäº†')) val.classList.add('badge-done');
                    else if (d.status.includes('ã‚­ãƒ£ãƒ³ã‚»ãƒ«')) val.classList.add('badge-cancel');
                }
                p.appendChild(label); p.appendChild(val); card.appendChild(p);
            });

            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´
            if (d.messages && d.messages.length > 0) {
                const p = document.createElement('p');
                p.innerHTML = '<span class="label">ãƒãƒ£ãƒƒãƒˆå±¥æ­´:</span>';
                const box = document.createElement('div');
                box.className = 'chat-box';
                d.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-msg';
                    const senderName = msg.sender === 'Admin' ? 'è‡ªåˆ†' : 'å®¢';
                    const senderClass = msg.sender === 'Admin' ? 'sender-admin' : 'sender-user';
                    div.innerHTML = `<span class="${senderClass}">${senderName}:</span> ${msg.text}`;
                    box.appendChild(div);
                });
                p.appendChild(box);
                card.appendChild(p);
            }

            if (d.ssUrl && d.ssUrl.startsWith("http")) {
                const p = document.createElement('p');
                const label = document.createElement('span');
                label.className = 'label';
                label.textContent = "è¨¼æ‹ : ";
                const a = document.createElement('a');
                a.href = d.ssUrl; a.target = "_blank"; a.textContent = "ğŸ“· ç”»åƒã‚’ç¢ºèª";
                p.appendChild(label); p.appendChild(a); card.appendChild(p);
            }
            area.appendChild(card);
        }

        function renderAdminTable(data) {
            const tbody = document.getElementById('admin-tbody');
            tbody.innerHTML = "";
            data.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));

            data.forEach(d => {
                const tr = document.createElement('tr');
                const addCell = (text, className = null) => {
                    const td = document.createElement('td');
                    td.textContent = text || "-";
                    if (className) td.classList.add(className);
                    tr.appendChild(td);
                };

                addCell(new Date(d.lastUpdate).toLocaleString('ja-JP'));
                addCell(d.userName);
                
                const tdSt = document.createElement('td');
                tdSt.textContent = d.status;
                if(d.status.includes("å¾…ã¡")) tdSt.classList.add("badge-wait");
                else if(d.status.includes("ä½œæ¥­")) tdSt.classList.add("badge-work");
                else if(d.status.includes("å®Œäº†")) tdSt.classList.add("badge-done");
                tr.appendChild(tdSt);

                addCell(d.item);

                const tdChat = document.createElement('td');
                if (d.messages && d.messages.length > 0) {
                    const box = document.createElement('div');
                    box.className = 'chat-box';
                    d.messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'chat-msg';
                        const senderName = msg.sender === 'Admin' ? 'è‡ªåˆ†' : 'å®¢';
                        const senderClass = msg.sender === 'Admin' ? 'sender-admin' : 'sender-user';
                        div.innerHTML = `<span class="${senderClass}">${senderName}:</span> ${msg.text}`;
                        box.appendChild(div);
                    });
                    tdChat.appendChild(box);
                } else { tdChat.textContent = "-"; }
                tr.appendChild(tdChat);

                addCell(d.amount);
                
                const tdImg = document.createElement('td');
                if (d.ssUrl && d.ssUrl.startsWith("http")) {
                    const a = document.createElement('a');
                    a.href = d.ssUrl; a.target = "_blank"; a.textContent = "ğŸ“·";
                    tdImg.appendChild(a);
                } else { tdImg.textContent = "-"; }
                tr.appendChild(tdImg);

                addCell(d.userId);
                tbody.appendChild(tr);
            });
        }

        function updateDashboard(data) {
            let total = 0, monthTotal = 0, wait = 0, work = 0;
            const now = new Date();
            data.forEach(d => {
                const amt = parseInt(d.amount) || 0;
                const st = d.status || "";
                if (!st.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) {
                    total += amt;
                    if (new Date(d.lastUpdate).getMonth() === now.getMonth()) monthTotal += amt;
                }
                if (st.includes("å¾…ã¡")) wait++;
                if (st.includes("ä½œæ¥­")) work++;
            });
            document.getElementById('stat-total').textContent = total.toLocaleString() + "å††";
            document.getElementById('stat-month').textContent = monthTotal.toLocaleString() + "å††";
            document.getElementById('stat-wait').textContent = wait + "ä»¶";
            document.getElementById('stat-work').textContent = work + "ä»¶";
        }

        function filterTable(type) {
            let filtered = globalData;
            if (type === 'wait') filtered = globalData.filter(d => d.status.includes('å¾…ã¡'));
            if (type === 'work') filtered = globalData.filter(d => d.status.includes('ä½œæ¥­'));
            if (type === 'done') filtered = globalData.filter(d => d.status.includes('å®Œäº†'));
            renderAdminTable(filtered);
        }
    </script>
</body>
</html>

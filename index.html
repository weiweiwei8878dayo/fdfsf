const { Client, GatewayIntentBits, ModalBuilder, TextInputBuilder, TextInputStyle, ActionRowBuilder, EmbedBuilder, InteractionType, REST, Routes, SlashCommandBuilder, ButtonBuilder, ButtonStyle, StringSelectMenuBuilder, MessageFlags, Partials, PermissionFlagsBits, ChannelType } = require('discord.js');
const fetch = require('node-fetch');

// --- è¨­å®šæƒ…å ± ---
const APP_ID = "1456569335190388951";
const TOKEN = "MTQ1NjU2OTMzNTE5MDM4ODk1MQ.Gy9DbE.8evT660iyPHVWKpYy2SWpzlzmcl0QDd3xnFI8c";
const ADMIN_ID = "1262777743368781834";
const JISSEKI_CHANNEL_ID = "1411011385512558752";
const NETLIFY_URL = "https://gxxf.netlify.app"; 

const client = new Client({ 
    intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMembers, GatewayIntentBits.DirectMessages, GatewayIntentBits.MessageContent], 
    partials: [Partials.Channel, Partials.Message] 
});

// --- Netlifyé€²æ—æ›´æ–°ç”¨é–¢æ•° ---
async function updateNetlifyStatus(userId, status, item = null) {
    const data = { userId, status, lastUpdate: new Date().toISOString() };
    if (item) data.item = item;

    try {
        await fetch(`${NETLIFY_URL}/.netlify/functions/save-id`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        console.log(`[Netlify] ${userId} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ "${status}" ã«æ›´æ–°ã—ã¾ã—ãŸã€‚`);
    } catch (err) {
        console.error("[Netlify] é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err);
    }
}

client.once('ready', async () => {
    console.log(`ğŸš€ Botèµ·å‹•: ${client.user.tag}`);
    const rest = new REST({ version: '10' }).setToken(TOKEN);
    const commands = [
        new SlashCommandBuilder().setName('daikou-panel').setDescription('ã«ã‚ƒã‚“ã“ä»£è¡Œãƒ‘ãƒãƒ«ã‚’è¨­ç½®'),
        new SlashCommandBuilder().setName('tsumu-panel').setDescription('ãƒ„ãƒ ãƒ„ãƒ ä»£è¡Œãƒ‘ãƒãƒ«ã‚’è¨­ç½®'),
        new SlashCommandBuilder().setName('ticket-panel').setDescription('ãƒã‚±ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚’è¨­ç½®')
    ];
    await rest.put(Routes.applicationCommands(APP_ID), { body: commands });
});

client.on('interactionCreate', async (interaction) => {
    const isAdmin = interaction.user.id === ADMIN_ID;

    // 1. ãƒ‘ãƒãƒ«è¨­ç½®
    if (interaction.isChatInputCommand()) {
        if (interaction.commandName === 'daikou-panel') {
            const select = new StringSelectMenuBuilder().setCustomId('menu_select_nyanko').setPlaceholder('ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ').addOptions([
                { label: 'å…¨ã‚­ãƒ£ãƒ©è§£æ”¾', description: '1000å††', value: 'å…¨ã‚­ãƒ£ãƒ©è§£æ”¾:1000' },
                { label: 'çŒ«ç¼¶ãƒ»XPãƒ»ãƒ‰ãƒªãƒ³ã‚¯', description: '500å††', value: 'çŒ«ç¼¶ç­‰:500' }
            ]);
            await interaction.reply({ content: "ğŸˆ ã«ã‚ƒã‚“ã“ä»£è¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼", components: [new ActionRowBuilder().addComponents(select)] });
        }
        if (interaction.commandName === 'tsumu-panel') {
            const select = new StringSelectMenuBuilder().setCustomId('menu_select_tsumu').setPlaceholder('ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ').addOptions([
                { label: '1å„„ã‚³ã‚¤ãƒ³', description: '300å††', value: '1å„„ã‚³ã‚¤ãƒ³:300' },
                { label: '2000ä¸‡ã‚³ã‚¤ãƒ³', description: '150å††', value: '2000ä¸‡ã‚³ã‚¤ãƒ³:150' },
                { label: 'ãƒ¬ãƒ™ãƒ«MAX', description: '400å††', value: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¬ãƒ™ãƒ«MAX:400' }
            ]);
            await interaction.reply({ content: "ğŸ¡ ãƒ„ãƒ ãƒ„ãƒ ä»£è¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼", components: [new ActionRowBuilder().addComponents(select)] });
        }
        if (interaction.commandName === 'ticket-panel') {
            const row = new ActionRowBuilder().addComponents(new ButtonBuilder().setCustomId('create_ticket').setLabel('ãƒã‚±ãƒƒãƒˆä½œæˆ').setStyle(ButtonStyle.Primary));
            await interaction.reply({ content: "ğŸ« ãŠå•ã„åˆã‚ã›ã¯ã“ã¡ã‚‰", components: [row] });
        }
    }

    // 2. ã‚»ãƒ¬ã‚¯ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ (ä¿è¨¼é¸æŠã¸)
    if (interaction.isStringSelectMenu()) {
        if (interaction.customId === 'menu_select_nyanko' || interaction.customId === 'menu_select_tsumu') {
            const [label, price] = interaction.values[0].split(':');
            const p = parseInt(price);
            const row = new ActionRowBuilder().addComponents(
                new ButtonBuilder().setCustomId(`conf_no_${p}_${label}`).setLabel('ä¿è¨¼ãªã—').setStyle(ButtonStyle.Secondary),
                new ButtonBuilder().setCustomId(`conf_yes_${p + 800}_${label}`).setLabel('ğŸ›¡ï¸ BANä¿è¨¼ã‚ã‚Š(+800å††)').setStyle(ButtonStyle.Success)
            );
            await interaction.reply({ content: `é¸æŠ: ${label} (${p}å††)\nä¿è¨¼ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`, components: [row], flags: [MessageFlags.Ephemeral] });
        }

        // ç®¡ç†è€…ï¼šæ™‚é–“é¸æŠ -> Netlifyã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€Œä½œæ¥­ä¸­ã€ã¸
        if (interaction.customId.startsWith('select_time_')) {
            if (!isAdmin) return;
            const targetId = interaction.customId.split('_')[2];
            const time = interaction.values[0];
            
            await updateNetlifyStatus(targetId, `ä½œæ¥­ä¸­ (ç›®å®‰:${time})`);

            const user = await client.users.fetch(targetId).catch(() => null);
            if (user) await user.send(`âœ… ãŠæ”¯æ‰•ã„ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ä½œæ¥­ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆç›®å®‰:${time}ï¼‰ã€‚`).catch(()=>{});
            await interaction.update({ content: `âœ… é€²è¡ŒçŠ¶æ³ã‚’ã€Œä½œæ¥­ä¸­ã€ã«æ›´æ–°ã—ã¾ã—ãŸã€‚`, components: [] });
        }
    }

    // 3. ãƒœã‚¿ãƒ³ & ãƒ¢ãƒ¼ãƒ€ãƒ«
    if (interaction.isButton()) {
        const parts = interaction.customId.split('_');

        if (parts[0] === 'conf') {
            const [, isBan, total, label] = parts;
            const row = new ActionRowBuilder().addComponents(new ButtonBuilder().setCustomId(`ag_req_${total}_${isBan}_${label}`).setLabel('åŒæ„ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã¸').setStyle(ButtonStyle.Primary));
            await interaction.reply({ content: `åˆè¨ˆ: ${total}å†† / å†…å®¹: ${label}\nè¦ç´„ã«åŒæ„ã—ã¾ã™ã‹ï¼Ÿ`, components: [row], flags: [MessageFlags.Ephemeral] });
        }

        if (parts[0] === 'ag') {
            const [, , total, isBan, label] = parts;
            const modal = new ModalBuilder().setCustomId(`modal_submit_${total}_${isBan}_${label}`).setTitle('ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ ');
            modal.addComponents(
                new ActionRowBuilder().addComponents(new TextInputBuilder().setCustomId('pp').setLabel(`PayPayãƒªãƒ³ã‚¯ (${total}å††)`).setStyle(1).setRequired(true)),
                new ActionRowBuilder().addComponents(new TextInputBuilder().setCustomId('code').setLabel('ã‚³ãƒ¼ãƒ‰/ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ').setStyle(1).setRequired(true)),
                new ActionRowBuilder().addComponents(new TextInputBuilder().setCustomId('auth').setLabel('èªè¨¼/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰').setStyle(1).setRequired(true))
            );
            await interaction.showModal(modal);
        }

        // ç®¡ç†è€…ãƒœã‚¿ãƒ³
        if (parts[0] === 'payok' && isAdmin) {
            const select = new StringSelectMenuBuilder().setCustomId(`select_time_${parts[1]}`).setPlaceholder('ç›®å®‰æ™‚é–“')
                .addOptions([{ label: '15åˆ†', value: '15åˆ†' }, { label: '30åˆ†', value: '30åˆ†' }, { label: '1æ™‚é–“', value: '1æ™‚é–“' }]);
            await interaction.reply({ content: "ä½œæ¥­æ™‚é–“ã‚’é¸æŠ:", components: [new ActionRowBuilder().addComponents(select)], flags: [MessageFlags.Ephemeral] });
        }

        if (parts[0] === 'finish' && isAdmin) {
            const modal = new ModalBuilder().setCustomId(`modal_finalreport_${parts[1]}`).setTitle('å®Œäº†å ±å‘Š');
            modal.addComponents(new ActionRowBuilder().addComponents(new TextInputBuilder().setCustomId('ss').setLabel('è¨¼æ‹ URL').setStyle(1).setRequired(true)));
            await interaction.showModal(modal);
        }

        if (interaction.customId === 'create_ticket') {
            const channel = await interaction.guild.channels.create({
                name: `ticket-${interaction.user.username}`,
                type: ChannelType.GuildText,
                permissionOverwrites: [{ id: interaction.guild.id, deny: [PermissionFlagsBits.ViewChannel] }, { id: interaction.user.id, allow: [PermissionFlagsBits.ViewChannel, PermissionFlagsBits.SendMessages] }, { id: ADMIN_ID, allow: [PermissionFlagsBits.ViewChannel, PermissionFlagsBits.SendMessages] }]
            });
            await interaction.reply({ content: `ãƒã‚±ãƒƒãƒˆä½œæˆ: ${channel}`, flags: [MessageFlags.Ephemeral] });
        }
    }

    if (interaction.type === InteractionType.ModalSubmit) {
        // ä¾é ¼é€ä¿¡ -> Netlifyã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€Œæ”¯æ‰•ã„ç¢ºèªå¾…ã¡ã€ã¸
        if (interaction.customId.startsWith('modal_submit_')) {
            const [, , total, isBan, label] = interaction.customId.split('_');
            
            await updateNetlifyStatus(interaction.user.id, "æ”¯æ‰•ã„ç¢ºèªå¾…ã¡", label);

            const admin = await client.users.fetch(ADMIN_ID);
            const embed = new EmbedBuilder().setTitle("ğŸ”” æ–°ç€ä¾é ¼").setColor(0x5865F2).addFields(
                { name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼", value: `${interaction.user.tag} (${interaction.user.id})` },
                { name: "å†…å®¹", value: `${label} / ${total}å††` },
                { name: "PayPay/æƒ…å ±", value: `ãƒªãƒ³ã‚¯: ${interaction.fields.getTextInputValue('pp')}\nå¢æƒ…å ±: ${interaction.fields.getTextInputValue('code')} / ${interaction.fields.getTextInputValue('auth')}` }
            );
            const row = new ActionRowBuilder().addComponents(
                new ButtonBuilder().setCustomId(`payok_${interaction.user.id}`).setLabel('ğŸ’° ç¢ºèª').setStyle(ButtonStyle.Success),
                new ButtonBuilder().setCustomId(`finish_${interaction.user.id}`).setLabel('ğŸ å®Œäº†').setStyle(ButtonStyle.Primary)
            );
            await admin.send({ embeds: [embed], components: [row] });
            await interaction.reply({ content: `âœ… é€ä¿¡å®Œäº†ï¼\né€²æ—ç¢ºèªURL: ${NETLIFY_URL}\nã‚ãªãŸã®ID: \`${interaction.user.id}\``, flags: [MessageFlags.Ephemeral] });
        }

        // å®Œäº†å ±å‘Š -> Netlifyã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€Œå®Œäº†ã€ã¸
        if (interaction.customId.startsWith('modal_finalreport_')) {
            const targetId = interaction.customId.split('_')[2];
            await updateNetlifyStatus(targetId, "å®Œäº†");
            await interaction.reply({ content: "å®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã€Netlifyã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚", flags: [MessageFlags.Ephemeral] });
        }
    }
});

client.login(TOKEN);

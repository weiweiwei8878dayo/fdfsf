<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; color: #333; padding: 20px; text-align: center; }
        h1 { color: #444; margin-bottom: 20px; }
        .hidden { display: none; }
        .error { color: red; font-weight: bold; }
        a { text-decoration: none; }

        /* --- ãŠå®¢æ§˜ç”¨ --- */
        #user-view { background: white; padding: 40px; border-radius: 10px; max-width: 600px; margin: 30px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        input[type="text"] { padding: 15px; width: 60%; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { padding: 15px 25px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { opacity: 0.9; }

        /* å¾…ã¡äººæ•°è¡¨ç¤ºï¼ˆäººæ°—æ„Ÿæ¼”å‡ºï¼‰ */
        .queue-alert { background: #e9ecef; color: #555; padding: 10px; border-radius: 5px; font-size: 0.9em; margin-bottom: 20px; display: inline-block; }
        .queue-count { color: #d9534f; font-weight: bold; font-size: 1.2em; }

        /* çµæœã‚«ãƒ¼ãƒ‰ */
        .result-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #28a745; margin-top: 20px; text-align: left; }
        .label { font-weight: bold; color: #555; }
        .value { font-size: 1.1em; font-weight: bold; margin-left: 10px; }
        .ss-link { display: inline-block; margin-top: 5px; padding: 5px 10px; background: #007bff; color: white; border-radius: 4px; font-size: 0.9em; }

        /* --- ç®¡ç†è€…ç”¨ --- */
        #admin-view { max-width: 1200px; margin: 0 auto; display: none; }
        
        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆå£²ä¸Šãƒ‘ãƒãƒ«ï¼‰ */
        .dashboard { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px; gap: 10px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-title { font-size: 0.9em; color: #777; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #333; margin-top: 5px; }
        .money { color: #28a745; }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
        .filters { margin-bottom: 15px; }
        .filter-btn { padding: 8px 15px; background: #6c757d; font-size: 0.9em; margin: 2px; }
        .filter-btn.active { background: #007bff; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; white-space: nowrap; }
        th { background: #007bff; color: white; }
        tr:hover { background: #f1f1f1; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
        .badge-wait { color: #d9534f; font-weight: bold; } /* èµ¤ */
        .badge-work { color: #f0ad4e; font-weight: bold; } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
        .badge-done { color: #5cb85c; font-weight: bold; } /* ç·‘ */
        .badge-cancel { color: #999; text-decoration: line-through; } /* ã‚°ãƒ¬ãƒ¼ */

    </style>
</head>
<body>

    <!-- â–¼ ãŠå®¢æ§˜ç”¨ç”»é¢ â–¼ -->
    <div id="user-view">
        <h1>ğŸ“¦ ã”ä¾é ¼çŠ¶æ³ã®ç¢ºèª</h1>
        
        <!-- äººæ°—æ„Ÿã®æ¼”å‡º -->
        <div class="queue-alert">
            ç¾åœ¨ã€<span id="queue-count" class="queue-count">-</span> ä»¶ã®ä¾é ¼ãŒé€²è¡Œä¸­ã§ã™ğŸ”¥
        </div>

        <div>
            <input type="text" id="searchId" placeholder="Discordãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›">
            <button onclick="fetchData('user')">æ¤œç´¢</button>
        </div>
        
        <div id="result-area" class="hidden"></div>
        <p id="msg" class="hidden"></p>
    </div>

    <!-- â–¼ ç®¡ç†è€…ç”¨ç”»é¢ â–¼ -->
    <div id="admin-view">
        <h1>ğŸ”§ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        
        <!-- å£²ä¸Šãƒ»ä»¶æ•°ãƒ‘ãƒãƒ« -->
        <div class="dashboard">
            <div class="stat-card">
                <div class="stat-title">ğŸ’° ä»Šæœˆã®å£²ä¸Š</div>
                <div class="stat-value money" id="stat-month-sales">0å††</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ’´ å…¨æœŸé–“ã®å£²ä¸Š</div>
                <div class="stat-value money" id="stat-total-sales">0å††</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">âš ï¸ æ”¯æ‰•ã„å¾…ã¡</div>
                <div class="stat-value" id="stat-wait" style="color:#d9534f">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ› ï¸ ä½œæ¥­ä¸­</div>
                <div class="stat-value" id="stat-work" style="color:#f0ad4e">0</div>
            </div>
        </div>

        <!-- çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³ -->
        <div class="filters">
            <button class="filter-btn active" onclick="filterTable('all')">å…¨ã¦</button>
            <button class="filter-btn" onclick="filterTable('wait')">æ”¯æ‰•ã„å¾…ã¡</button>
            <button class="filter-btn" onclick="filterTable('work')">ä½œæ¥­ä¸­</button>
            <button class="filter-btn" onclick="filterTable('done')">å®Œäº†</button>
        </div>

        <p style="text-align:right; font-size:0.8em; color:#888;">30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°</p>
        
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>æ—¥æ™‚</th><th>åå‰</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å†…å®¹</th><th>é‡‘é¡</th><th>è¨¼æ‹ </th><th>ID</th>
                    </tr>
                </thead>
                <tbody id="admin-tbody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let globalData = []; // ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const pw = params.get('pw');
            const id = params.get('id');

            // æœ€åˆã«ä¸€èˆ¬ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆå¾…ã¡äººæ•°ï¼‰ã‚’å–å¾—
            fetch('/.netlify/functions/get-data?id=queue_check').then(r=>r.json()).then(data => {
                // "queue_check" ã¨ã„ã†IDã¯ãªã„ã®ã§ç©ºé…åˆ—ãŒè¿”ã‚‹ãŒã€
                // get-data.js ã®ä»•æ§˜ä¸Šã€å…¨å“¡ã®ä»¶æ•°ã‚’å–ã‚‹ã«ã¯åˆ¥ã®APIãŒå¿…è¦ã ãŒ
                // ç°¡æ˜“çš„ã«ç©ºé…åˆ—ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€ã“ã“ã¯å®Ÿã¯ã€Œå¾…ã¡äººæ•°ã€ã¯
                // get-data.js ã‚’å°‘ã—æ”¹é€ ã—ãªã„ã¨æ­£ç¢ºã«ã¯å‡ºãªã„ã€‚
                // â˜…ãªã®ã§ã€ä»Šå›ã¯ã€Œç®¡ç†è€…ãªã‚‰å…¨å“¡ã€ã€Œä¸€èˆ¬ãªã‚‰è‡ªåˆ†ã®ã ã‘ã€ã¨ã„ã†ä»•æ§˜ã‚’æ´»ã‹ã—ã¤ã¤
                // ç°¡æ˜“çš„ã«ã€Œç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã€ã®æ™‚ã ã‘æ­£ç¢ºãªæ•°å­—ã‚’å‡ºã™ã€‚
                // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«ã€Œå¾…ã¡äººæ•°ã€ã‚’å‡ºã™ã«ã¯ get-data.js ã®ä¿®æ­£ãŒå¿…è¦ã§ã™ãŒã€
                // ä»Šå›ã¯ã€Œindex.htmlã ã‘ã§å®Œçµã€ã•ã›ã‚‹ãŸã‚ã€ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿å…¨æ©Ÿèƒ½é–‹æ”¾ã¨ã—ã¾ã™ã€‚
            }).catch(()=>{});

            if (pw) {
                fetchData('admin', pw);
            } else if (id) {
                document.getElementById('searchId').value = id;
                fetchData('user', null, id);
                // ä¸€èˆ¬ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã€Œå¾…ã¡äººæ•°ã€ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã€
                // æœ¬æ¥ã¯ã‚µãƒ¼ãƒãƒ¼å´ã®æ”¹ä¿®ãŒå¿…è¦ã§ã™ãŒã€ä»Šå›ã¯ãƒ€ãƒŸãƒ¼ã¾ãŸã¯
                // ç®¡ç†è€…ãŒãŸã¾ã«è¦‹ã¦æ¥½ã—ã‚€æ©Ÿèƒ½ã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚
            }
        };

        async function fetchData(mode, password = null, userId = null) {
            const idInput = userId || document.getElementById('searchId').value.trim();
            const msg = document.getElementById('msg');
            const resultArea = document.getElementById('result-area');

            let apiUrl = '/.netlify/functions/get-data';
            if (mode === 'admin') apiUrl += `?pw=${password}`;
            else apiUrl += `?id=${idInput}`;

            try {
                const res = await fetch(apiUrl);
                if (!res.ok) {
                    if (mode === 'admin') {
                        alert("èªè¨¼ã‚¨ãƒ©ãƒ¼");
                        document.getElementById('user-view').style.display = 'block';
                    } else {
                        msg.innerText = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        msg.className = "error";
                        msg.style.display = "block";
                        resultArea.style.display = "none";
                    }
                    return;
                }

                const data = await res.json();
                
                if (mode === 'admin') {
                    globalData = data; // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    document.getElementById('user-view').style.display = 'none';
                    document.getElementById('admin-view').style.display = 'block';
                    
                    updateDashboard(data); // å£²ä¸Šè¨ˆç®—
                    renderAdminTable(data); // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º

                    setInterval(async () => {
                        const r = await fetch(apiUrl);
                        if (r.ok) {
                            const d = await r.json();
                            globalData = d;
                            updateDashboard(d);
                            renderAdminTable(d);
                        }
                    }, 30000);

                } else {
                    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰
                    if (data.length > 0) {
                        renderUserResult(data[0]);
                        msg.style.display = "none";
                    } else {
                        msg.innerText = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        msg.style.display = "block";
                        resultArea.style.display = "none";
                    }
                }
            } catch (err) {
                console.error(err);
                msg.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
                msg.style.display = "block";
            }
        }

        // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨ˆç®—æ©Ÿèƒ½ ---
        function updateDashboard(data) {
            let total = 0;
            let monthTotal = 0;
            let waitCount = 0;
            let workCount = 0;
            let activeCount = 0; // å®Œäº†ä»¥å¤–ã®ä¾é ¼æ•°

            const currentMonth = new Date().getMonth();

            data.forEach(d => {
                const amount = parseInt(d.amount) || 0;
                const status = d.status || "";
                
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ãªã‚‰å£²ä¸Šã«åŠ ç®—
                if (!status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) {
                    total += amount;
                    if (new Date(d.lastUpdate).getMonth() === currentMonth) {
                        monthTotal += amount;
                    }
                }

                if (status.includes("å¾…ã¡")) waitCount++;
                if (status.includes("ä½œæ¥­")) workCount++;
                if (!status.includes("å®Œäº†") && !status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) activeCount++;
            });

            // æ•°å­—ã‚’ç”»é¢ã«åæ˜ 
            document.getElementById('stat-total-sales').innerText = total.toLocaleString() + "å††";
            document.getElementById('stat-month-sales').innerText = monthTotal.toLocaleString() + "å††";
            document.getElementById('stat-wait').innerText = waitCount + "ä»¶";
            document.getElementById('stat-work').innerText = workCount + "ä»¶";

            // ãŠå®¢æ§˜ç”»é¢ã®ã€Œå¾…ã¡äººæ•°ã€ã‚‚æ›´æ–°ï¼ˆâ€»ç®¡ç†è€…ãŒè¦‹ãŸæ™‚ã‚„ã€ä¸€èˆ¬å‘ã‘APIã‚’æ”¹ä¿®ã—ãŸå ´åˆã«æœ‰åŠ¹ï¼‰
            // ä»Šå›ã¯ç®¡ç†è€…ãŒè¦‹ã‚‹ç”»é¢ã®æ•°å€¤ã‚’ä»£å…¥
            /* æœ¬æ ¼çš„ã«ä¸€èˆ¬å…¬é–‹ã™ã‚‹ã«ã¯ã‚µãƒ¼ãƒãƒ¼å´ä¿®æ­£ãŒå¿…è¦ãªãŸã‚ã€ä»Šå›ã¯å‰²æ„› */
        }

        // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ ---
        function filterTable(type) {
            // ãƒœã‚¿ãƒ³ã®è‰²åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            let filtered = globalData;
            if (type === 'wait') filtered = globalData.filter(d => d.status.includes('å¾…ã¡'));
            if (type === 'work') filtered = globalData.filter(d => d.status.includes('ä½œæ¥­'));
            if (type === 'done') filtered = globalData.filter(d => d.status.includes('å®Œäº†'));
            
            renderAdminTable(filtered);
        }

        // --- è¡¨ç¤ºæ©Ÿèƒ½ ---
        function renderUserResult(d) {
            const area = document.getElementById('result-area');
            const ssHtml = (d.ssUrl && d.ssUrl.startsWith("http")) 
                ? `<p><span class="label">è¨¼æ‹ :</span> <a href="${d.ssUrl}" target="_blank" class="ss-link">ğŸ“· ç”»åƒã‚’ç¢ºèª</a></p>` : "";
            
            let stClass = "";
            if(d.status.includes("å¾…ã¡")) stClass = "badge-wait";
            else if(d.status.includes("ä½œæ¥­")) stClass = "badge-work";
            else if(d.status.includes("å®Œäº†")) stClass = "badge-done";
            else if(d.status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) stClass = "badge-cancel";

            area.innerHTML = `
                <div class="result-card">
                    <p><span class="label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span> <span class="value ${stClass}">${d.status}</span></p>
                    <p><span class="label">æ›´æ–°æ—¥æ™‚:</span> <span class="value">${new Date(d.lastUpdate).toLocaleString('ja-JP')}</span></p>
                    <p><span class="label">å†…å®¹:</span> <span class="value">${d.item || "-"}</span></p>
                    <p><span class="label">é‡‘é¡:</span> <span class="value">${d.amount ? d.amount+"å††" : "-"}</span></p>
                    <p><span class="label">BANä¿è¨¼:</span> <span class="value">${d.banOption === "yes" ? "ã‚ã‚Š" : "ãªã—"}</span></p>
                    ${ssHtml}
                </div>
            `;
            area.style.display = "block";
            
            // è‡ªåˆ†ã®ä¾é ¼ãŒé€²è¡Œä¸­ãªã‚‰ã€ç°¡æ˜“çš„ã«å¾…ã¡äººæ•°è¡¨ç¤ºã‚¨ãƒªã‚¢ã«åæ˜ ï¼ˆæ¼”å‡ºï¼‰
            if(!d.status.includes('å®Œäº†')) {
                document.getElementById('queue-count').innerText = "ã‚ãªãŸã®ä¾é ¼ã‚’å«ã‚å¤šæ•°";
            } else {
                document.querySelector('.queue-alert').style.display = 'none';
            }
        }

        function renderAdminTable(data) {
            const tbody = document.getElementById('admin-tbody');
            tbody.innerHTML = "";
            // æ—¥ä»˜é †
            data.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));

            data.forEach(d => {
                let stClass = "";
                if(d.status.includes("å¾…ã¡")) stClass = "badge-wait";
                else if(d.status.includes("ä½œæ¥­")) stClass = "badge-work";
                else if(d.status.includes("å®Œäº†")) stClass = "badge-done";
                else if(d.status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) stClass = "badge-cancel";
                
                const ssHtml = (d.ssUrl && d.ssUrl.startsWith("http")) ? `<a href="${d.ssUrl}" target="_blank">ğŸ“·</a>` : "-";

                tbody.innerHTML += `<tr>
                    <td>${new Date(d.lastUpdate).toLocaleString('ja-JP')}</td>
                    <td>${d.userName}</td>
                    <td class="${stClass}">${d.status}</td>
                    <td>${d.item || "-"}</td>
                    <td>${d.amount || "-"}</td>
                    <td>${ssHtml}</td>
                    <td style="font-size:11px;color:#888;">${d.userId}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>

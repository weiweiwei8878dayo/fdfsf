<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è¡Œç®¡ç†ãƒ‘ãƒãƒ«</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; color: #333; margin: 0; padding: 0; }
        
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ (ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³) */
        .navbar { background: #333; padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .nav-links button { background: none; border: none; color: #ddd; font-size: 16px; cursor: pointer; margin-left: 20px; font-weight: bold; }
        .nav-links button.active { color: #fff; border-bottom: 2px solid #28a745; }
        .nav-links button:hover { color: #fff; }

        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button.btn { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button.btn-danger { background: #d9534f; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-view { margin-top: 100px; text-align: center; }
        
        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
        .dashboard { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; flex: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #007bff; color: white; }

        /* å•†å“ç®¡ç† */
        .product-group { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .product-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .product-row input[type="text"] { flex: 2; }
        .product-row input[type="number"] { flex: 1; }

        /* ãƒãƒ£ãƒƒãƒˆå±¥æ­´ */
        .chat-box { max-height: 100px; overflow-y: auto; font-size: 0.85em; }
    </style>
</head>
<body>

    <!-- â–¼ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ (ãƒ­ã‚°ã‚¤ãƒ³å¾Œè¡¨ç¤º) â–¼ -->
    <nav id="navbar" class="navbar hidden">
        <div style="font-weight:bold; font-size:1.2em;">ğŸ”§ ç®¡ç†ãƒ‘ãƒãƒ«</div>
        <div class="nav-links">
            <button id="tab-dash" class="active" onclick="switchTab('dash')">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
            <button id="tab-prod" onclick="switchTab('prod')">âœï¸ å•†å“ç®¡ç†</button>
            <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </nav>

    <!-- â–¼ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ â–¼ -->
    <div id="login-view">
        <h1>ğŸ”’ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
        <input type="password" id="adminPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p style="margin-top:20px; font-size:0.9em; color:#666;">â€»ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã¯ä¿å­˜ã•ã‚Œã¾ã™</p>
    </div>

    <div class="container">
        <!-- â–¼ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ â–¼ -->
        <div id="dash-view" class="hidden">
            <div class="dashboard">
                <div class="stat-card"><div>ğŸ’° ä»Šæœˆã®å£²ä¸Š</div><div class="stat-value" id="stat-month" style="color:#28a745">-</div></div>
                <div class="stat-card"><div>ğŸ’´ ç·å£²ä¸Š</div><div class="stat-value" id="stat-total" style="color:#28a745">-</div></div>
                <div class="stat-card"><div>âš ï¸ æ”¯æ‰•ã„å¾…ã¡</div><div class="stat-value" id="stat-wait" style="color:#d9534f">-</div></div>
                <div class="stat-card"><div>ğŸ› ï¸ ä½œæ¥­ä¸­</div><div class="stat-value" id="stat-work" style="color:#f0ad4e">-</div></div>
            </div>
            
            <div style="margin-bottom:10px;">
                <button class="btn" onclick="fetchOrders()">ğŸ”„ æ›´æ–°</button>
            </div>
            <div style="overflow-x:auto;">
                <table id="order-table">
                    <thead><tr><th>æ—¥æ™‚</th><th>åå‰</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å†…å®¹</th><th>ãƒãƒ£ãƒƒãƒˆ</th><th>é‡‘é¡</th><th>è¨¼æ‹ </th><th>ID</th></tr></thead>
                    <tbody id="order-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- â–¼ å•†å“ç®¡ç†ç”»é¢ â–¼ -->
        <div id="prod-view" class="hidden">
            <h2>âœï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç·¨é›†</h2>
            <p>Botã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹é …ç›®ã¨ä¾¡æ ¼ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
            
            <div class="product-group">
                <h3>ğŸˆ ã«ã‚ƒã‚“ã“å¤§æˆ¦äº‰</h3>
                <div id="list-nyanko"></div>
                <button class="btn" onclick="addRow('nyanko')">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>
            </div>

            <div class="product-group">
                <h3>ğŸ¡ ãƒ„ãƒ ãƒ„ãƒ </h3>
                <div id="list-tsumu"></div>
                <button class="btn" onclick="addRow('tsumu')">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>
            </div>

            <div style="text-align:right; margin-top:20px;">
                <button class="btn" style="padding:15px 40px; font-size:1.2em;" onclick="saveProducts()">ğŸ’¾ ä¿å­˜ã—ã¦åæ˜ </button>
            </div>
        </div>
    </div>

    <script>
        // --- ã‚¯ãƒƒã‚­ãƒ¼æ“ä½œé–¢æ•° ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }
        function eraseCookie(name) { document.cookie = name+'=; Max-Age=-99999999;'; }

        // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
        let currentPass = "";

        window.onload = () => {
            const savedPass = getCookie("admin_pass");
            if (savedPass) {
                document.getElementById('adminPass').value = savedPass;
                login();
            }
        };

        async function login() {
            const pass = document.getElementById('adminPass').value;
            // èªè¨¼ãƒã‚§ãƒƒã‚¯ (ãƒ€ãƒŸãƒ¼å–å¾—ã§ç¢ºèª)
            try {
                const res = await fetch('/.netlify/functions/get-data', {
                    method: 'POST', body: JSON.stringify({ password: pass })
                });
                if (res.ok) {
                    currentPass = pass;
                    setCookie("admin_pass", pass, 7); // 7æ—¥é–“ä¿å­˜
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('navbar').classList.remove('hidden');
                    switchTab('dash');
                } else {
                    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
                    eraseCookie("admin_pass");
                }
            } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); }
        }

        function logout() {
            eraseCookie("admin_pass");
            location.reload();
        }

        function switchTab(tab) {
            document.getElementById('dash-view').classList.add('hidden');
            document.getElementById('prod-view').classList.add('hidden');
            document.getElementById('tab-dash').classList.remove('active');
            document.getElementById('tab-prod').classList.remove('active');

            if (tab === 'dash') {
                document.getElementById('dash-view').classList.remove('hidden');
                document.getElementById('tab-dash').classList.add('active');
                fetchOrders();
            } else {
                document.getElementById('prod-view').classList.remove('hidden');
                document.getElementById('tab-prod').classList.add('active');
                fetchProducts();
            }
        }

        // --- æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾— (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰) ---
        async function fetchOrders() {
            const res = await fetch('/.netlify/functions/get-data', {
                method: 'POST', body: JSON.stringify({ password: currentPass })
            });
            const data = await res.json();
            renderTable(data);
            calcStats(data);
        }

        function renderTable(data) {
            const tbody = document.getElementById('order-tbody');
            tbody.innerHTML = "";
            data.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));
            data.forEach(d => {
                let stStyle = "";
                if(d.status.includes("å¾…ã¡")) stStyle="color:#d9534f;font-weight:bold;";
                if(d.status.includes("ä½œæ¥­")) stStyle="color:#f0ad4e;font-weight:bold;";
                if(d.status.includes("å®Œäº†")) stStyle="color:#5cb85c;font-weight:bold;";
                
                let chatHtml = "-";
                if(d.messages && d.messages.length > 0) {
                    chatHtml = `<div class="chat-box">${d.messages.map(m=>`<div><b>${m.sender==="Admin"?"è‡ªåˆ†":"å®¢"}:</b> ${m.text}</div>`).join('')}</div>`;
                }
                const ssHtml = d.ssUrl?.startsWith("http") ? `<a href="${d.ssUrl}" target="_blank">ğŸ“·</a>` : "-";

                tbody.innerHTML += `<tr>
                    <td>${new Date(d.lastUpdate).toLocaleString('ja-JP')}</td>
                    <td>${d.userName}</td>
                    <td style="${stStyle}">${d.status}</td>
                    <td>${d.item||"-"}</td>
                    <td>${chatHtml}</td>
                    <td>${d.amount}</td>
                    <td>${ssHtml}</td>
                    <td style="font-size:0.8em;color:#999;">${d.userId}</td>
                </tr>`;
            });
        }

        function calcStats(data) {
            let total=0, month=0, wait=0, work=0;
            const now = new Date();
            data.forEach(d => {
                const amt = parseInt(d.amount)||0;
                if(!d.status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) {
                    total += amt;
                    if(new Date(d.lastUpdate).getMonth() === now.getMonth()) month += amt;
                }
                if(d.status.includes("å¾…ã¡")) wait++;
                if(d.status.includes("ä½œæ¥­")) work++;
            });
            document.getElementById('stat-total').innerText = total.toLocaleString() + "å††";
            document.getElementById('stat-month').innerText = month.toLocaleString() + "å††";
            document.getElementById('stat-wait').innerText = wait;
            document.getElementById('stat-work').innerText = work;
        }

        // --- å•†å“ç®¡ç†æ©Ÿèƒ½ ---
        let productData = { nyanko: [], tsumu: [] };

        async function fetchProducts() {
            const res = await fetch('/.netlify/functions/product-api');
            productData = await res.json();
            renderProductList('nyanko', productData.nyanko);
            renderProductList('tsumu', productData.tsumu);
        }

        function renderProductList(type, list) {
            const container = document.getElementById(`list-${type}`);
            container.innerHTML = "";
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'product-row';
                div.innerHTML = `
                    <input type="text" value="${item.label}" placeholder="å•†å“å" onchange="updateProd('${type}', ${index}, 'label', this.value)">
                    <input type="number" value="${item.price}" placeholder="ä¾¡æ ¼" onchange="updateProd('${type}', ${index}, 'price', this.value)">
                    <span>å††</span>
                    <button class="btn btn-danger" onclick="delRow('${type}', ${index})">å‰Šé™¤</button>
                `;
                container.appendChild(div);
            });
        }

        function updateProd(type, index, key, val) {
            if(key === 'price') val = parseInt(val);
            productData[type][index][key] = val;
        }

        function addRow(type) {
            productData[type].push({ label: "", price: 0 });
            renderProductList(type, productData[type]);
        }

        function delRow(type, index) {
            productData[type].splice(index, 1);
            renderProductList(type, productData[type]);
        }

        async function saveProducts() {
            if(!confirm("å•†å“ã‚’ä¿å­˜ã—ã¦Botã«åæ˜ ã•ã›ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                const res = await fetch('/.netlify/functions/product-api', {
                    method: 'POST',
                    body: JSON.stringify({ password: currentPass, products: productData })
                });
                if(res.ok) alert("âœ… ä¿å­˜ã—ã¾ã—ãŸï¼\nBotã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ›´æ–°ã™ã‚‹ã«ã¯Botã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚");
                else alert("ä¿å­˜å¤±æ•—");
            } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); }
        }
    </script>
</body>
</html>

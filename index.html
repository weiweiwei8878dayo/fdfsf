<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; color: #333; padding: 20px; text-align: center; }
        h1 { color: #444; margin-bottom: 20px; }
        .hidden { display: none; }
        .error { color: red; font-weight: bold; }
        a { text-decoration: none; }

        /* ãŠå®¢æ§˜ç”¨ */
        #user-view { background: white; padding: 40px; border-radius: 10px; max-width: 600px; margin: 30px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        input[type="text"] { padding: 15px; width: 60%; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { padding: 15px 25px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { opacity: 0.9; }

        /* å¾…ã¡äººæ•°è¡¨ç¤ºï¼ˆäººæ°—æ„Ÿæ¼”å‡ºï¼‰ */
        .queue-alert { background: #e9ecef; color: #555; padding: 10px; border-radius: 5px; font-size: 0.9em; margin-bottom: 20px; display: inline-block; }
        .queue-count { color: #d9534f; font-weight: bold; font-size: 1.2em; }

        /* çµæœã‚«ãƒ¼ãƒ‰ */
        .result-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #28a745; margin-top: 20px; text-align: left; }
        .label { font-weight: bold; color: #555; }
        .value { font-size: 1.1em; font-weight: bold; margin-left: 10px; }
        .ss-link { display: inline-block; margin-top: 5px; padding: 5px 10px; background: #007bff; color: white; border-radius: 4px; font-size: 0.9em; }

        /* ç®¡ç†è€…ç”¨ */
        #admin-view { max-width: 1200px; margin: 0 auto; display: none; }
        .dashboard { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px; gap: 10px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-title { font-size: 0.9em; color: #777; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #333; margin-top: 5px; }
        .money { color: #28a745; }

        .filters { margin-bottom: 15px; }
        .filter-btn { padding: 8px 15px; background: #6c757d; font-size: 0.9em; margin: 2px; }
        .filter-btn.active { background: #007bff; }

        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; white-space: nowrap; }
        th { background: #007bff; color: white; }
        tr:hover { background: #f1f1f1; }
        
        .badge-wait { color: #d9534f; font-weight: bold; }
        .badge-work { color: #f0ad4e; font-weight: bold; }
        .badge-done { color: #5cb85c; font-weight: bold; }
        .badge-cancel { color: #999; text-decoration: line-through; }

    </style>
</head>
<body>

    <!-- ãŠå®¢æ§˜ç”¨ç”»é¢ -->
    <div id="user-view">
        <h1>ğŸ“¦ ã”ä¾é ¼çŠ¶æ³ã®ç¢ºèª</h1>
        
        <!-- ã“ã“ã«äººæ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
        <div class="queue-alert">
            ç¾åœ¨ã€<span id="queue-count" class="queue-count">èª­ã¿è¾¼ã¿ä¸­...</span> ä»¶ã®ä¾é ¼ãŒé€²è¡Œä¸­ã§ã™ğŸ”¥
        </div>

        <div>
            <input type="text" id="searchId" placeholder="Discordãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›">
            <button onclick="fetchData('user')">æ¤œç´¢</button>
        </div>
        
        <div id="result-area" class="hidden"></div>
        <p id="msg" class="hidden"></p>
    </div>

    <!-- ç®¡ç†è€…ç”¨ç”»é¢ -->
    <div id="admin-view">
        <h1>ğŸ”§ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        
        <div class="dashboard">
            <div class="stat-card">
                <div class="stat-title">ğŸ’° ä»Šæœˆã®å£²ä¸Š</div>
                <div class="stat-value money" id="stat-month-sales">0å††</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ’´ å…¨æœŸé–“ã®å£²ä¸Š</div>
                <div class="stat-value money" id="stat-total-sales">0å††</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">âš ï¸ æ”¯æ‰•ã„å¾…ã¡</div>
                <div class="stat-value" id="stat-wait" style="color:#d9534f">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ğŸ› ï¸ ä½œæ¥­ä¸­</div>
                <div class="stat-value" id="stat-work" style="color:#f0ad4e">0</div>
            </div>
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="filterTable('all')">å…¨ã¦</button>
            <button class="filter-btn" onclick="filterTable('wait')">æ”¯æ‰•ã„å¾…ã¡</button>
            <button class="filter-btn" onclick="filterTable('work')">ä½œæ¥­ä¸­</button>
            <button class="filter-btn" onclick="filterTable('done')">å®Œäº†</button>
        </div>

        <div class="table-wrap">
            <table id="adminTable">
                <thead>
                    <tr>
                        <th>æ—¥æ™‚</th><th>åå‰</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å†…å®¹</th><th>é‡‘é¡</th><th>è¨¼æ‹ </th><th>ID</th>
                    </tr>
                </thead>
                <tbody id="admin-tbody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let globalData = [];

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const pw = params.get('pw');
            const id = params.get('id');

            // ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã€Œå¾…ã¡äººæ•°ã€ã‚’å–å¾—ã—ã¦è¡¨ç¤º
            fetch('/.netlify/functions/get-data?id=queue_count')
                .then(res => res.json())
                .then(data => {
                    // ã‚‚ã—ä»¶æ•°ãŒ0ãªã‚‰ã€Œ0ã€ã¨è¡¨ç¤º
                    document.getElementById('queue-count').innerText = data.count !== undefined ? data.count : "0";
                })
                .catch(() => {
                    document.getElementById('queue-count').innerText = "0";
                });

            if (pw) {
                fetchData('admin', pw);
            } else if (id) {
                document.getElementById('searchId').value = id;
                fetchData('user', null, id);
            }
        };

        async function fetchData(mode, password = null, userId = null) {
            const idInput = userId || document.getElementById('searchId').value.trim();
            const msg = document.getElementById('msg');
            const resultArea = document.getElementById('result-area');

            let apiUrl = '/.netlify/functions/get-data';
            if (mode === 'admin') apiUrl += `?pw=${password}`;
            else apiUrl += `?id=${idInput}`;

            try {
                const res = await fetch(apiUrl);
                if (!res.ok) {
                    if (mode === 'admin') {
                        alert("èªè¨¼ã‚¨ãƒ©ãƒ¼");
                        document.getElementById('user-view').style.display = 'block';
                    } else {
                        msg.innerText = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        msg.className = "error";
                        msg.style.display = "block";
                        resultArea.style.display = "none";
                    }
                    return;
                }

                const data = await res.json();
                
                if (mode === 'admin') {
                    globalData = data;
                    document.getElementById('user-view').style.display = 'none';
                    document.getElementById('admin-view').style.display = 'block';
                    
                    updateDashboard(data);
                    renderAdminTable(data);

                    setInterval(async () => {
                        const r = await fetch(apiUrl);
                        if (r.ok) {
                            const d = await r.json();
                            globalData = d;
                            updateDashboard(d);
                            renderAdminTable(d);
                        }
                    }, 30000);

                } else {
                    if (data.length > 0) {
                        renderUserResult(data[0]);
                        msg.style.display = "none";
                    } else {
                        msg.innerText = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        msg.style.display = "block";
                        resultArea.style.display = "none";
                    }
                }
            } catch (err) {
                console.error(err);
                msg.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
                msg.style.display = "block";
            }
        }

        function updateDashboard(data) {
            let total = 0; let monthTotal = 0; let waitCount = 0; let workCount = 0;
            const currentMonth = new Date().getMonth();

            data.forEach(d => {
                const amount = parseInt(d.amount) || 0;
                const status = d.status || "";
                
                if (!status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) {
                    total += amount;
                    if (new Date(d.lastUpdate).getMonth() === currentMonth) monthTotal += amount;
                }
                if (status.includes("å¾…ã¡")) waitCount++;
                if (status.includes("ä½œæ¥­")) workCount++;
            });

            document.getElementById('stat-total-sales').innerText = total.toLocaleString() + "å††";
            document.getElementById('stat-month-sales').innerText = monthTotal.toLocaleString() + "å††";
            document.getElementById('stat-wait').innerText = waitCount + "ä»¶";
            document.getElementById('stat-work').innerText = workCount + "ä»¶";
        }

        function filterTable(type) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            let filtered = globalData;
            if (type === 'wait') filtered = globalData.filter(d => d.status.includes('å¾…ã¡'));
            if (type === 'work') filtered = globalData.filter(d => d.status.includes('ä½œæ¥­'));
            if (type === 'done') filtered = globalData.filter(d => d.status.includes('å®Œäº†'));
            renderAdminTable(filtered);
        }

        function renderUserResult(d) {
            const area = document.getElementById('result-area');
            const ssHtml = (d.ssUrl && d.ssUrl.startsWith("http")) ? `<p><span class="label">è¨¼æ‹ :</span> <a href="${d.ssUrl}" target="_blank" class="ss-link">ğŸ“· ç”»åƒã‚’ç¢ºèª</a></p>` : "";
            let stClass = "";
            if(d.status.includes("å¾…ã¡")) stClass = "badge-wait";
            else if(d.status.includes("ä½œæ¥­")) stClass = "badge-work";
            else if(d.status.includes("å®Œäº†")) stClass = "badge-done";
            else if(d.status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) stClass = "badge-cancel";

            area.innerHTML = `
                <div class="result-card">
                    <p><span class="label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span> <span class="value ${stClass}">${d.status}</span></p>
                    <p><span class="label">æ›´æ–°æ—¥æ™‚:</span> <span class="value">${new Date(d.lastUpdate).toLocaleString('ja-JP')}</span></p>
                    <p><span class="label">å†…å®¹:</span> <span class="value">${d.item || "-"}</span></p>
                    <p><span class="label">é‡‘é¡:</span> <span class="value">${d.amount ? d.amount+"å††" : "-"}</span></p>
                    <p><span class="label">BANä¿è¨¼:</span> <span class="value">${d.banOption === "yes" ? "ã‚ã‚Š" : "ãªã—"}</span></p>
                    ${ssHtml}
                </div>
            `;
            area.style.display = "block";
        }

        function renderAdminTable(data) {
            const tbody = document.getElementById('admin-tbody');
            tbody.innerHTML = "";
            data.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));

            data.forEach(d => {
                let stClass = "";
                if(d.status.includes("å¾…ã¡")) stClass = "badge-wait";
                else if(d.status.includes("ä½œæ¥­")) stClass = "badge-work";
                else if(d.status.includes("å®Œäº†")) stClass = "badge-done";
                else if(d.status.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")) stClass = "badge-cancel";
                
                const ssHtml = (d.ssUrl && d.ssUrl.startsWith("http")) ? `<a href="${d.ssUrl}" target="_blank">ğŸ“·</a>` : "-";

                tbody.innerHTML += `<tr>
                    <td>${new Date(d.lastUpdate).toLocaleString('ja-JP')}</td>
                    <td>${d.userName}</td>
                    <td class="${stClass}">${d.status}</td>
                    <td>${d.item || "-"}</td>
                    <td>${d.amount || "-"}</td>
                    <td>${ssHtml}</td>
                    <td style="font-size:11px;color:#888;">${d.userId}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>

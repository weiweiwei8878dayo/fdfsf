<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; color: #333; padding: 20px; text-align: center; }
        h1 { color: #444; margin-bottom: 20px; }
        .hidden { display: none; }
        .error { color: red; font-weight: bold; }

        /* ãŠå®¢æ§˜ç”¨ */
        #user-view { background: white; padding: 40px; border-radius: 10px; max-width: 600px; margin: 50px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        input[type="text"] { padding: 15px; width: 60%; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { padding: 15px 25px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* çµæœè¡¨ç¤º */
        .result-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #28a745; margin-top: 20px; text-align: left; }
        .label { font-weight: bold; color: #555; }
        .value { font-size: 1.1em; font-weight: bold; margin-left: 10px; }
        .ss-link { display: inline-block; margin-top: 5px; padding: 5px 10px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em; }

        /* ç®¡ç†è€…ç”¨ */
        #admin-view { max-width: 1200px; margin: 0 auto; display: none; }
        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #007bff; color: white; }
        .badge-wait { color: #d9534f; font-weight: bold; }
        .badge-work { color: #f0ad4e; font-weight: bold; }
        .badge-done { color: #5cb85c; font-weight: bold; }
    </style>
</head>
<body>

    <!-- ãŠå®¢æ§˜ç”¨ç”»é¢ -->
    <div id="user-view">
        <h1>ğŸ“¦ ã”ä¾é ¼çŠ¶æ³ã®ç¢ºèª</h1>
        <div>
            <input type="text" id="searchId" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›">
            <button onclick="fetchData('user')">æ¤œç´¢</button>
        </div>
        <div id="result-area" class="hidden"></div>
        <p id="msg" class="hidden"></p>
    </div>

    <!-- ç®¡ç†è€…ç”¨ç”»é¢ -->
    <div id="admin-view">
        <h1>ğŸ”§ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p style="text-align:right;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="admin-status">æ¥ç¶šä¸­</span></p>
        <table>
            <thead>
                <tr>
                    <th>æ—¥æ™‚</th><th>åå‰</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å†…å®¹</th><th>é‡‘é¡</th><th>è¨¼æ‹ </th><th>ID</th>
                </tr>
            </thead>
            <tbody id="admin-tbody"></tbody>
        </table>
    </div>

    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const pw = params.get('pw'); // URLã® ?pw=...
            const id = params.get('id'); // URLã® ?id=...

            if (pw) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹ãªã‚‰ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è©¦ã¿ã‚‹
                fetchData('admin', pw);
            } else if (id) {
                // IDãŒã‚ã‚‹ãªã‚‰è‡ªå‹•æ¤œç´¢
                document.getElementById('searchId').value = id;
                fetchData('user', null, id);
            }
        };

        async function fetchData(mode, password = null, userId = null) {
            const idInput = userId || document.getElementById('searchId').value.trim();
            const msg = document.getElementById('msg');
            const resultArea = document.getElementById('result-area');

            // APIã¸ã®å•ã„åˆã‚ã›URLã‚’ä½œæˆ
            let apiUrl = '/.netlify/functions/get-data';
            if (mode === 'admin') apiUrl += `?pw=${password}`;
            else apiUrl += `?id=${idInput}`;

            try {
                const res = await fetch(apiUrl);
                
                // èªè¨¼ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãªã—
                if (!res.ok) {
                    if (mode === 'admin') {
                        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ï¼ˆã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼‰");
                        // ä¸€èˆ¬ç”»é¢ã«æˆ»ã™
                        document.getElementById('user-view').style.display = 'block';
                        document.getElementById('admin-view').style.display = 'none';
                    } else {
                        msg.innerText = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        msg.className = "error";
                        msg.style.display = "block";
                        resultArea.style.display = "none";
                    }
                    return;
                }

                const data = await res.json();

                if (mode === 'admin') {
                    // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰æˆåŠŸ
                    document.getElementById('user-view').style.display = 'none';
                    document.getElementById('admin-view').style.display = 'block';
                    renderAdminTable(data);
                    
                    // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãã§å†å–å¾—ï¼‰
                    setInterval(async () => {
                        const r = await fetch(apiUrl);
                        if (r.ok) renderAdminTable(await r.json());
                    }, 30000);

                } else {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢æˆåŠŸ
                    if (data.length > 0) {
                        renderUserResult(data[0]);
                        msg.style.display = "none";
                    } else {
                        msg.innerText = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        msg.style.display = "block";
                        resultArea.style.display = "none";
                    }
                }

            } catch (err) {
                console.error(err);
                msg.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                msg.style.display = "block";
            }
        }

        // --- è¡¨ç¤ºç”¨ã®é–¢æ•° ---

        function renderUserResult(d) {
            const area = document.getElementById('result-area');
            const ssHtml = (d.ssUrl && d.ssUrl.startsWith("http")) 
                ? `<p><span class="label">è¨¼æ‹ :</span> <a href="${d.ssUrl}" target="_blank" class="ss-link">ğŸ“· ç”»åƒã‚’è¦‹ã‚‹</a></p>` : "";
            
            let stClass = "";
            if(d.status.includes("å¾…ã¡")) stClass = "badge-wait";
            else if(d.status.includes("ä½œæ¥­")) stClass = "badge-work";
            else if(d.status.includes("å®Œäº†")) stClass = "badge-done";

            area.innerHTML = `
                <div class="result-card">
                    <p><span class="label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span> <span class="value ${stClass}">${d.status}</span></p>
                    <p><span class="label">æ›´æ–°æ—¥æ™‚:</span> <span class="value">${new Date(d.lastUpdate).toLocaleString('ja-JP')}</span></p>
                    <p><span class="label">å†…å®¹:</span> <span class="value">${d.item || "-"}</span></p>
                    <p><span class="label">é‡‘é¡:</span> <span class="value">${d.amount ? d.amount+"å††" : "-"}</span></p>
                    <p><span class="label">BANä¿è¨¼:</span> <span class="value">${d.banOption === "yes" ? "ã‚ã‚Š" : "ãªã—"}</span></p>
                    ${ssHtml}
                </div>
            `;
            area.style.display = "block";
        }

        function renderAdminTable(data) {
            const tbody = document.getElementById('admin-tbody');
            tbody.innerHTML = "";
            data.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));

            data.forEach(d => {
                let stClass = "";
                if(d.status.includes("å¾…ã¡")) stClass = "badge-wait";
                else if(d.status.includes("ä½œæ¥­")) stClass = "badge-work";
                else if(d.status.includes("å®Œäº†")) stClass = "badge-done";
                
                const ssHtml = (d.ssUrl && d.ssUrl.startsWith("http")) ? `<a href="${d.ssUrl}" target="_blank">ç”»åƒ</a>` : "-";

                tbody.innerHTML += `<tr>
                    <td>${new Date(d.lastUpdate).toLocaleString('ja-JP')}</td>
                    <td>${d.userName}</td>
                    <td class="${stClass}">${d.status}</td>
                    <td>${d.item || "-"}</td>
                    <td>${d.amount || "-"}</td>
                    <td>${ssHtml}</td>
                    <td style="font-size:11px;color:#888;">${d.userId}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>

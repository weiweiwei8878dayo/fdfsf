<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; color: #333; padding: 20px; text-align: center; }
        h1 { color: #444; margin-bottom: 20px; }
        .hidden { display: none !important; }
        .error { color: red; font-weight: bold; }
        a { text-decoration: none; cursor: pointer; color: #007bff; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; margin: 5px; }
        button { padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { opacity: 0.9; }
        .container { background: white; padding: 40px; border-radius: 10px; max-width: 600px; margin: 30px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .queue-alert { background: #e9ecef; color: #555; padding: 10px; border-radius: 5px; margin-bottom: 20px; display: inline-block; }
        .queue-count { color: #d9534f; font-weight: bold; font-size: 1.2em; }
        .result-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #28a745; margin-top: 20px; text-align: left; }
        .label { font-weight: bold; color: #555; }
        .value { font-weight: bold; margin-left: 10px; }
        
        #admin-view { max-width: 1200px; margin: 0 auto; }
        .dashboard { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-value { font-size: 1.5em; font-weight: bold; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background: #007bff; color: white; }
        .badge-wait { color: #d9534f; } .badge-work { color: #f0ad4e; } .badge-done { color: #5cb85c; } .badge-cancel { color: #999; text-decoration: line-through; }
        .chat-box { font-size: 0.85em; text-align: left; max-height: 120px; overflow-y: auto; background: #f8f9fa; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px; }
        .chat-msg { margin-bottom: 6px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .sender-admin { color: #007bff; font-weight: bold; } .sender-user { color: #28a745; font-weight: bold; }
        .chat-time { font-size: 0.7em; color: #999; margin-left: 5px; float: right; }
    </style>
</head>
<body>
    <div id="login-view" class="container">
        <h1>ğŸ”’ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
        <input type="password" id="adminPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <br><button type="button" onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p style="margin-top:15px;"><a onclick="showUserView()">ä¸€èˆ¬ã®ãŠå®¢æ§˜ã¯ã“ã¡ã‚‰</a></p>
    </div>

    <div id="user-view" class="container hidden">
        <h1>ğŸ“¦ ã”ä¾é ¼çŠ¶æ³ã®ç¢ºèª</h1>
        <div class="queue-alert">ç¾åœ¨ã€<span id="queue-count" class="queue-count">-</span> ä»¶ã®ä¾é ¼ãŒé€²è¡Œä¸­ã§ã™ğŸ”¥</div>
        <div>
            <input type="text" id="searchId" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (ä¾‹: 123...)"><br>
            <input type="text" id="searchOrderId" placeholder="æ³¨æ–‡ID (ä¾‹: AB12CD34)"><br>
            <button type="button" onclick="fetchUserData()">æ¤œç´¢</button>
        </div>
        <div id="result-area" class="hidden"></div>
        <p id="msg" class="hidden error"></p>
        <p style="margin-top:15px;"><a onclick="showLoginView()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a></p>
    </div>

    <div id="admin-view" class="hidden">
        <h1>ğŸ”§ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <div class="dashboard">
            <div class="stat-card"><div>ğŸ’° ä»Šæœˆã®å£²ä¸Š</div><div class="stat-value" id="stat-month" style="color:#28a745">0å††</div></div>
            <div class="stat-card"><div>ğŸ’´ å…¨æœŸé–“ã®å£²ä¸Š</div><div class="stat-value" id="stat-total" style="color:#28a745">0å††</div></div>
            <div class="stat-card"><div>âš ï¸ æ”¯æ‰•ã„å¾…ã¡</div><div class="stat-value" id="stat-wait" style="color:#d9534f">0</div></div>
            <div class="stat-card"><div>ğŸ› ï¸ ä½œæ¥­ä¸­</div><div class="stat-value" id="stat-work" style="color:#f0ad4e">0</div></div>
        </div>
        <div style="margin-bottom:15px;">
            <button type="button" onclick="filterTable('all')">å…¨ã¦</button>
            <button type="button" onclick="filterTable('wait')">æ”¯æ‰•ã„å¾…ã¡</button>
            <button type="button" onclick="filterTable('work')">ä½œæ¥­ä¸­</button>
            <button type="button" style="background:#17a2b8;" onclick="downloadCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
            <button type="button" style="background:#ffc107;color:black;" onclick="enableSound()">ğŸ”” é€šçŸ¥éŸ³ON</button>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>æ—¥æ™‚</th><th>åå‰</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å†…å®¹</th><th>âœ‰ï¸ ãƒãƒ£ãƒƒãƒˆ</th><th>é‡‘é¡</th><th>è¨¼æ‹ </th><th>ID</th></tr></thead>
                <tbody id="admin-tbody"></tbody>
            </table>
        </div>
        <p style="margin-top:20px;"><a onclick="showLoginView()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a></p>
    </div>

    <audio id="alert-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

    <script>
        let globalData = [];
        let lastWaitCount = 0;
        let soundEnabled = false;

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const orderId = params.get('orderId');
            fetch('/.netlify/functions/get-data?id=queue_count').then(r=>r.json()).then(d=>{document.getElementById('queue-count').textContent=d.count||0}).catch(()=>{});
            if(id && orderId){ document.getElementById('searchId').value=id; document.getElementById('searchOrderId').value=orderId; showUserView(); fetchUserData(); } else { showLoginView(); }
        };

        function showLoginView(){ document.getElementById('login-view').classList.remove('hidden'); document.getElementById('user-view').classList.add('hidden'); document.getElementById('admin-view').classList.add('hidden'); }
        function showUserView(){ document.getElementById('login-view').classList.add('hidden'); document.getElementById('user-view').classList.remove('hidden'); document.getElementById('admin-view').classList.add('hidden'); }
        function showAdminView(){ document.getElementById('login-view').classList.add('hidden'); document.getElementById('user-view').classList.add('hidden'); document.getElementById('admin-view').classList.remove('hidden'); }

        async function adminLogin() {
            const password = document.getElementById('adminPass').value;
            try {
                const res = await fetch('/.netlify/functions/get-data', { method: 'POST', body: JSON.stringify({ password }) });
                if(res.ok){
                    const data = await res.json();
                    globalData = data;
                    showAdminView();
                    updateDashboard(data);
                    renderAdminTable(data);
                    // è‡ªå‹•æ›´æ–°é–‹å§‹
                    setInterval(async()=>{
                        const r = await fetch('/.netlify/functions/get-data', { method: 'POST', body: JSON.stringify({ password }) });
                        if(r.ok){
                            const d = await r.json();
                            globalData = d;
                            updateDashboard(d);
                            renderAdminTable(d);
                        }
                    }, 30000);
                } else { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); }
            } catch(e){ alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼'); }
        }

        async function fetchUserData() {
            const userId = document.getElementById('searchId').value.trim();
            const orderId = document.getElementById('searchOrderId').value.trim();
            const msg = document.getElementById('msg');
            const resultArea = document.getElementById('result-area');
            if(!userId || !orderId){ msg.textContent="IDã¨æ³¨æ–‡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; msg.classList.remove('hidden'); return; }
            try {
                const res = await fetch(`/.netlify/functions/get-data?id=${userId}&orderId=${orderId}`);
                const data = await res.json();
                if(data.length>0){ msg.classList.add('hidden'); resultArea.classList.remove('hidden'); renderUserCard(data[0]); }
                else { msg.textContent="ãƒ‡ãƒ¼ã‚¿ãªã—"; msg.classList.remove('hidden'); resultArea.classList.add('hidden'); }
            } catch(e){ msg.textContent="é€šä¿¡ã‚¨ãƒ©ãƒ¼"; msg.classList.remove('hidden'); }
        }

        function renderUserCard(d){
            const area=document.getElementById('result-area'); area.innerHTML='';
            const card=document.createElement('div'); card.className='result-card';
            const fields=[{l:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',v:d.status},{l:'æ—¥æ™‚',v:new Date(d.lastUpdate).toLocaleString('ja-JP')},{l:'å†…å®¹',v:d.item},{l:'é‡‘é¡',v:d.amount+"å††"},{l:'ä¿è¨¼',v:d.banOption==="yes"?"ã‚ã‚Š":"ãªã—"}];
            fields.forEach(f=>{
                const p=document.createElement('p');
                const val=document.createElement('span'); val.className='value'; val.textContent=f.v;
                if(f.l==='ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹' && d.status.includes('å¾…ã¡')) val.classList.add('badge-wait');
                p.innerHTML=`<span class="label">${f.l}:</span>`; p.appendChild(val); card.appendChild(p);
            });
            if(d.ssUrl && d.ssUrl.startsWith("http")){
                const p=document.createElement('p');
                p.innerHTML=`<span class="label">è¨¼æ‹ :</span> <a href="${d.ssUrl}" target="_blank" class="ss-link">ğŸ“· ç”»åƒ</a>`;
                card.appendChild(p);
            }
            area.appendChild(card);
        }

        function renderAdminTable(data){
            const tbody=document.getElementById('admin-tbody'); tbody.innerHTML="";
            data.sort((a,b)=>new Date(b.lastUpdate)-new Date(a.lastUpdate));
            data.forEach(d=>{
                const tr=document.createElement('tr');
                const add=(txt,cls,html)=>{ const td=document.createElement('td'); if(html)td.innerHTML=txt;else td.textContent=txt||"-"; if(cls)td.classList.add(cls); tr.appendChild(td); };
                add(new Date(d.lastUpdate).toLocaleString('ja-JP'));
                add(d.userName);
                
                let stCls=""; if(d.status.includes("å¾…ã¡"))stCls="badge-wait"; else if(d.status.includes("ä½œæ¥­"))stCls="badge-work"; else if(d.status.includes("å®Œäº†"))stCls="badge-done";
                add(d.status, stCls);
                add(d.item);

                // ãƒãƒ£ãƒƒãƒˆ
                const tdChat=document.createElement('td');
                if(d.messages && d.messages.length>0){
                    const box=document.createElement('div'); box.className='chat-box';
                    d.messages.forEach(m=>{
                        const div=document.createElement('div'); div.className='chat-msg';
                        const cls=m.sender==='Admin'?'sender-admin':'sender-user';
                        div.innerHTML=`<span class="${cls}">${m.sender}:</span> ${m.text} <span class="chat-time">${m.time.split(' ')[1]}</span>`;
                        box.appendChild(div);
                    });
                    tdChat.appendChild(box);
                } else tdChat.textContent="-";
                tr.appendChild(tdChat);

                add(d.amount);
                const ss = (d.ssUrl&&d.ssUrl.startsWith("http"))?`<a href="${d.ssUrl}" target="_blank">ğŸ“·</a>`:"-";
                add(ss,null,true);
                add(d.userId);
                tbody.appendChild(tr);
            });
        }

        function updateDashboard(data){
            let t=0, mt=0, w=0, wk=0; const now=new Date();
            data.forEach(d=>{
                const amt=parseInt(d.amount)||0; const st=d.status||"";
                if(!st.includes("ã‚­ãƒ£ãƒ³ã‚»ãƒ«")){ t+=amt; if(new Date(d.lastUpdate).getMonth()===now.getMonth())mt+=amt; }
                if(st.includes("å¾…ã¡")) w++; if(st.includes("ä½œæ¥­")) wk++;
            });
            document.getElementById('stat-total').textContent=t.toLocaleString()+"å††";
            document.getElementById('stat-month').textContent=mt.toLocaleString()+"å††";
            document.getElementById('stat-wait').textContent=w+"ä»¶";
            document.getElementById('stat-work').textContent=wk+"ä»¶";

            // é€šçŸ¥éŸ³åˆ¤å®š
            if(w > lastWaitCount && soundEnabled) { document.getElementById('alert-sound').play().catch(()=>{}); }
            lastWaitCount = w;
        }

        function filterTable(type){
            let f=globalData;
            if(type==='wait')f=globalData.filter(d=>d.status.includes('å¾…ã¡'));
            if(type==='work')f=globalData.filter(d=>d.status.includes('ä½œæ¥­'));
            if(type==='done')f=globalData.filter(d=>d.status.includes('å®Œäº†'));
            renderAdminTable(f);
        }

        function enableSound(){ soundEnabled=true; alert("é€šçŸ¥éŸ³ã‚’ONã«ã—ã¾ã—ãŸã€‚\næ–°ã—ã„ä¾é ¼ãŒæ¥ã‚‹ã¨éŸ³ãŒé³´ã‚Šã¾ã™ã€‚"); document.getElementById('alert-sound').play(); }

        function downloadCSV(){
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOMä»˜ã
            csvContent += "æ—¥æ™‚,ãƒ¦ãƒ¼ã‚¶ãƒ¼å,ID,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,å†…å®¹,é‡‘é¡,BANä¿è¨¼,æ³¨æ–‡ID\n";
            globalData.forEach(d => {
                const row = [
                    new Date(d.lastUpdate).toLocaleString('ja-JP'),
                    d.userName, d.userId, d.status, d.item, d.amount, d.banOption, d.orderId
                ].map(e => `"${e || ''}"`).join(",");
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sales_data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
